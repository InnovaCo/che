<!DOCTYPE html><html lang="en"><head><title>app/client/sections</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../"><meta name="groc-document-path" content="app/client/sections"><meta name="groc-project-path" content="app/client/sections.coffee"><link rel="stylesheet" type="text/css" media="all" href="../../assets/style.css"><script type="text/javascript" src="../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">app/client/sections.coffee</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="cm">#### *module* sections</span>
<span class="cm">#</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Основной модуль для работы с секциями, умеет загружать, кэшировать и менять секции с помощью модулей
"sections/loader", "sections/transition", "sections/cache".
Также не будет работать, если модуль history возвращает false (это происходит при отсутствии historyAPI)</p></div></div><div class="code"><div class="wrapper"><span class="cm">#</span>



<span class="cm">define [&quot;history&quot;, &quot;events&quot;, &quot;sections/loader&quot;, &quot;sections/transition&quot;, &quot;sections/cache&quot;],  (history, events, sectionsLoader, Transition, cache) -&gt;</span>
<span class="cm">  return false if not history</span>

<span class="cm">  ###</span><span class="c1"># transitions</span>
  <span class="c1">#</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Менеджер переходов, создает, либо достает уже ранее созданные переходы</p></div></div><div class="code"><div class="wrapper">  <span class="c1">#</span>

  <span class="nv">transitions =</span>
    <span class="cm">######</span> <span class="nx">transitions</span><span class="p">.</span><span class="nx">last</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Самый последний созданный переход</p></div></div><div class="code"><div class="wrapper">    <span class="c1">#</span>
    <span class="nv">last: </span><span class="kc">null</span>

    <span class="cm">######</span> <span class="nx">transitions</span><span class="p">.</span><span class="nx">current</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Текущий примененный переход, в случае, когда был переход назад по истории, current не равен last</p></div></div><div class="code"><div class="wrapper">    <span class="c1">#</span>
    <span class="nv">current: </span><span class="kc">null</span>

    <span class="cm">######</span> <span class="nx">transitions</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Создает новый объект перехода, устанавливает в нем ссылки на предыдущий, а сам новый теперь записывается в last,
кроме того, обновляются, либо записываются данные в historyState. Если же такой переход уже был создан (state имеет параметр index),
то совершается ищем по индексу нужный переход, применяем его (функция transitions.go) и обновляем его данные</p></div></div><div class="code"><div class="wrapper">    <span class="c1">#</span>
    <span class="nv">create: </span><span class="nf">(state) -&gt;</span>
      <span class="nv">state = </span><span class="nx">state</span> <span class="o">or</span> <span class="p">{</span><span class="nv">index: </span><span class="mi">0</span><span class="p">,</span> <span class="nv">url: </span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span><span class="p">}</span>
      <span class="k">if</span> <span class="nx">@last</span><span class="o">?</span> <span class="o">and</span> <span class="nx">state</span><span class="p">.</span><span class="nx">index</span> <span class="o">&lt;=</span> <span class="nx">@last</span><span class="p">.</span><span class="nx">index</span>
        <span class="nv">transition = </span><span class="nx">@go</span> <span class="nx">state</span><span class="p">.</span><span class="nx">index</span>
        <span class="nx">transition</span><span class="p">.</span><span class="nx">update</span> <span class="nx">state</span>
        <span class="k">return</span> <span class="nx">transition</span>
      <span class="k">else</span>
        <span class="nv">isNewState = </span><span class="p">(</span><span class="nx">history</span><span class="p">.</span><span class="nx">state</span> <span class="o">or</span> <span class="p">{}).</span><span class="nx">url</span> <span class="o">isnt</span> <span class="nx">state</span><span class="p">.</span><span class="nx">url</span>
        <span class="nv">method = </span><span class="k">if</span> <span class="nx">isNewState</span> <span class="k">then</span> <span class="s">&quot;pushState&quot;</span> <span class="k">else</span> <span class="s">&quot;replaceState&quot;</span>
        <span class="nx">history</span><span class="p">[</span><span class="nx">method</span><span class="p">]</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">url</span>
        <span class="vi">@last = </span><span class="k">new</span> <span class="nx">Transition</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">@last</span>
        <span class="k">return</span> <span class="nx">@last</span>

    <span class="cm">######</span> <span class="nx">transitions</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Запускает все переходы от текущего до перехода с указанным индексом</p></div></div><div class="code"><div class="wrapper">    <span class="c1">#</span>

    <span class="nv">go: </span><span class="nf">(index) -&gt;</span>
      <span class="k">if</span> <span class="o">not</span> <span class="nx">@current</span>
        <span class="k">return</span> <span class="nx">@create</span><span class="p">()</span>

      <span class="k">return</span> <span class="nx">@current</span> <span class="k">if</span> <span class="nx">index</span> <span class="o">is</span> <span class="nx">@current</span><span class="o">?</span><span class="p">.</span><span class="nx">index</span>
      <span class="nv">direction = </span><span class="k">if</span> <span class="nx">@current</span><span class="p">.</span><span class="nx">index</span> <span class="o">&lt;</span> <span class="nx">index</span> <span class="k">then</span> <span class="s">&quot;next&quot;</span> <span class="k">else</span> <span class="s">&quot;prev&quot;</span>
      <span class="k">return</span> <span class="nx">@current</span><span class="p">[</span><span class="nx">direction</span><span class="p">](</span><span class="nx">index</span><span class="p">)</span>

  <span class="cm">#### Обработка события &quot;transition:current:update&quot;</span>
<span class="cm">  #</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Обновление ссылки на текущий переход</p></div></div><div class="code"><div class="wrapper"><span class="cm">  #</span>
<span class="cm">  events.bind &quot;transition:current:update&quot;, (transition) -&gt;</span>
<span class="cm">    transitions.current = transition</span>

<span class="cm">  ###</span><span class="c1"># Обработка события &quot;sections:loaded&quot;</span>
  <span class="c1">#</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Секции сохраняются в кэш, и далее отдаются на инициализацию</p></div></div><div class="code"><div class="wrapper">  <span class="c1">#</span>
  <span class="nx">events</span><span class="p">.</span><span class="nx">bind</span> <span class="s">&quot;sections:loaded&quot;</span><span class="p">,</span> <span class="nf">(state) -&gt;</span>
    <span class="nx">cache</span><span class="p">.</span><span class="nx">save</span> <span class="nx">state</span>
    <span class="nx">transitions</span><span class="p">.</span><span class="nx">create</span> <span class="nx">state</span>

  <span class="cm">#### Обработка события pageTransition:init</span>
<span class="cm">  #</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Проверяется, есть ли такие секции уже в кэше, если есть, то используем их и параллельно смотрим на сервере</p></div></div><div class="code"><div class="wrapper"><span class="cm">  #</span>
<span class="cm">  events.bind &quot;pageTransition:init&quot;, (url, sectionsHeader, method, formData) -&gt;</span>
<span class="cm">    state = cache.get url, sectionsHeader</span>

<span class="cm">    index = transitions.last?.index + 1 or 0</span>
<span class="cm">    if state?</span>
<span class="cm">      state.index = index</span>
<span class="cm">      transitions.create state</span>

<span class="cm">    sectionsLoader url, method, sectionsHeader, index, formData</span>


<span class="cm">  ###</span><span class="c1"># Обработка события history:popState</span>
  <span class="c1">#</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Переходит до нужного состояния и проверяет обновления на сервере</p></div></div><div class="code"><div class="wrapper">  <span class="c1">#</span>
  <span class="nx">events</span><span class="p">.</span><span class="nx">bind</span> <span class="s">&quot;history:popState&quot;</span><span class="p">,</span> <span class="nf">(state) -&gt;</span>
    <span class="k">if</span> <span class="nx">state</span><span class="o">?</span>
      <span class="nx">transitions</span><span class="p">.</span><span class="nx">go</span> <span class="nx">state</span><span class="p">.</span><span class="nx">index</span>
      <span class="k">if</span> <span class="nx">state</span><span class="p">.</span><span class="nx">url</span><span class="o">?</span>
        <span class="nx">sectionsLoader</span> <span class="nx">state</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">method</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">sectionsHeader</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">index</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>here ask server for updated sections (history case)</p></div></div><div class="code"><div class="wrapper">  <span class="c1">#### Событие transition:current:update</span>
  <span class="c1">#</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Создается первый пустой переход, он отражает текущее состояние страницы</p></div></div><div class="code"><div class="wrapper">  <span class="c1">#</span>
  <span class="nx">events</span><span class="p">.</span><span class="nx">trigger</span> <span class="s">&quot;transition:current:update&quot;</span><span class="p">,</span> <span class="nx">transitions</span><span class="p">.</span><span class="nx">create</span><span class="p">()</span>

  <span class="k">return</span> <span class="p">{</span>
    <span class="nv">_transitions: </span><span class="nx">transitions</span>
  <span class="p">}</span></div></div></div></div></body></html>