<!DOCTYPE html>

<html>
<head>
  <title>dom.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="ajax.html">
                ajax.coffee
              </a>
            
              
              <a class="source" href="app-require-config.html">
                app-require-config.coffee
              </a>
            
              
              <a class="source" href="app.html">
                app.coffee
              </a>
            
              
              <a class="source" href="clicks.html">
                clicks.coffee
              </a>
            
              
              <a class="source" href="anchors.html">
                anchors.coffee
              </a>
            
              
              <a class="source" href="forms.html">
                forms.coffee
              </a>
            
              
              <a class="source" href="config.html">
                config.coffee
              </a>
            
              
              <a class="source" href="dom.html">
                dom.coffee
              </a>
            
              
              <a class="source" href="events.html">
                events.coffee
              </a>
            
              
              <a class="source" href="history.html">
                history.coffee
              </a>
            
              
              <a class="source" href="async.html">
                async.coffee
              </a>
            
              
              <a class="source" href="loader.html">
                loader.coffee
              </a>
            
              
              <a class="source" href="sections.html">
                sections.coffee
              </a>
            
              
              <a class="source" href="asyncQueue.html">
                asyncQueue.coffee
              </a>
            
              
              <a class="source" href="cache.html">
                cache.coffee
              </a>
            
              
              <a class="source" href="invoker.html">
                invoker.coffee
              </a>
            
              
              <a class="source" href="loader.html">
                loader.coffee
              </a>
            
              
              <a class="source" href="transition.html">
                transition.coffee
              </a>
            
              
              <a class="source" href="destroyer.html">
                destroyer.coffee
              </a>
            
              
              <a class="source" href="guid.html">
                guid.coffee
              </a>
            
              
              <a class="source" href="log.html">
                log.coffee
              </a>
            
              
              <a class="source" href="logWriter.html">
                logWriter.coffee
              </a>
            
              
              <a class="source" href="params.html">
                params.coffee
              </a>
            
              
              <a class="source" href="storage.html">
                storage.coffee
              </a>
            
              
              <a class="source" href="ticker.html">
                ticker.coffee
              </a>
            
              
              <a class="source" href="widgetsData.html">
                widgetsData.coffee
              </a>
            
              
              <a class="source" href="widgets.html">
                widgets.coffee
              </a>
            
              
              <a class="source" href="gradient.html">
                gradient.coffee
              </a>
            
              
              <a class="source" href="opacity.html">
                opacity.coffee
              </a>
            
              
              <a class="source" href="perspective.html">
                perspective.coffee
              </a>
            
              
              <a class="source" href="rotation.html">
                rotation.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>dom.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h3><em>module</em> dom</h3>
<p>Содержит вспомогательные функции для обхода DOM-дерева, и навешивания обработчиков событий, позволяет обходится без большого jquery.
Интерфейс стремится быть похожим на интефейс jquery, конечно реализация сильно отличается</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>define [<span class="string">"utils/guid"</span>, <span class="string">"lib/domReady"</span>, <span class="string">"underscore"</span>], (guid, domReady, _) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h3>checkIsElementMatchSelector(selector, element, [root])</h3>
<p>Проверяет, подходит ли указанный селектор для элемента</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  
  <span class="function"><span class="title">checkIsElementMatchSelector</span></span> = (selectorOrNodeList, element, root) -&gt;
    <span class="keyword">return</span> <span class="literal">false</span> <span class="keyword">if</span> element <span class="keyword">is</span> root <span class="keyword">or</span> <span class="keyword">not</span> element
    root = root <span class="keyword">or</span> document
    list = <span class="keyword">if</span> _.isString(selectorOrNodeList) <span class="keyword">then</span> domQuery(root).find(selectorOrNodeList).get() <span class="keyword">else</span> selectorOrNodeList
    <span class="keyword">for</span> listElement <span class="keyword">in</span> list
      <span class="keyword">return</span> listElement <span class="keyword">if</span> listElement <span class="keyword">is</span> element

    <span class="keyword">return</span> checkIsElementMatchSelector list, element.parentNode, root</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h3>callEventHandlers(handlers, eventObj)</h3>
<p>Вызывает обработчики событий</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  
  <span class="function"><span class="title">callEventHandlers</span></span> = (handlers, eventObj, context) -&gt;
    <span class="keyword">for</span> handler <span class="keyword">in</span> handlers
      result = handler.call context, eventObj
      <span class="keyword">if</span> result <span class="keyword">is</span> <span class="literal">false</span>
        <span class="keyword">return</span> <span class="literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h3>query(selector, [root])</h3>
<p>Возвращает элементы для указанного селектора</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="function"><span class="title">query</span></span> = (selector, root) -&gt;
    <span class="keyword">if</span> window.jQuery
      <span class="function"><span class="title">query</span></span> = (selector, root) -&gt;
        <span class="keyword">return</span> window.jQuery(root <span class="keyword">or</span> document).find(selector).get()

      <span class="keyword">return</span> query.apply <span class="keyword">this</span>, arguments

    <span class="keyword">if</span> document.querySelectorAll?
      <span class="keyword">if</span> _.isString selector
        root = <span class="keyword">if</span> <span class="keyword">not</span> root <span class="keyword">or</span> root.length <span class="keyword">is</span> <span class="number">0</span> <span class="keyword">then</span> document <span class="keyword">else</span> root
        <span class="keyword">if</span> <span class="keyword">not</span> root.length
          root = [root]
        result = []
        _.each root, (root) -&gt;
          <span class="keyword">if</span> root.querySelectorAll?
            result = result.concat(Array::slice.call root.querySelectorAll(selector))
        <span class="keyword">return</span> result
      <span class="keyword">else</span> 
        <span class="keyword">return</span> selector
    <span class="keyword">else</span>
      console?.log <span class="string">"haven't tools for selecting node (module helpers/dom)"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h3>unbindEvent(node, eventName, handler)</h3>
<p>Отвязывает обработчика от события для указанного DOM-элемента</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="function"><span class="title">unbindEvent</span></span> =  (node, eventName, handler) -&gt;
    <span class="keyword">if</span> node.removeEventListener
      <span class="function"><span class="title">unbindEvent</span></span> = (node, eventName, handler) -&gt;
        node.removeEventListener eventName, handler, <span class="literal">false</span>
    <span class="keyword">else</span> <span class="keyword">if</span> node.detachEvent
      <span class="function"><span class="title">unbindEvent</span></span> = (node, eventName, handler) -&gt;
        node.detachEvent <span class="string">"on"</span> + eventName, handler
    <span class="keyword">else</span>
      <span class="keyword">return</span> console?.log <span class="string">"cannot unbind event (module helpers/dom)"</span>

    unbindEvent.apply <span class="keyword">this</span>, arguments</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <h3>bindEvent(node, eventName, handler)</h3>
<p>Привязывает обработчик к событию для указанного DOM-элемента</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="function"><span class="title">bindEvent</span></span> = (node, eventName, handler) -&gt;
    <span class="keyword">if</span> node.addEventListener
      <span class="function"><span class="title">bindEvent</span></span> = (node, eventName, handler) -&gt;
        node.addEventListener eventName, handler, <span class="literal">false</span>
    <span class="keyword">else</span> <span class="keyword">if</span> node.attachEvent
      <span class="function"><span class="title">bindEvent</span></span> = (node, eventName, handler) -&gt;
        node.attachEvent <span class="string">"on"</span> + eventName, handler
    <span class="keyword">else</span>
      <span class="keyword">return</span> console?.log <span class="string">"cannot bind event (module helpers/dom)"</span>

    bindEvent.apply <span class="keyword">this</span>, arguments</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <h3>delegateEvent(node, selector, eventName, handler)</h3>
<p>Привязывает обработчика события на DOM-элемент, делегирует ему события с элементов по селектору</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="function"><span class="title">delegateEvent</span></span> = (node, selector, eventName, handler) -&gt;
    <span class="keyword">if</span> <span class="keyword">not</span> node.domQueryDelegateHandler
      <span class="function"><span class="title">delegateHandler</span></span> = (e) -&gt;
        eventObject = e <span class="keyword">or</span> window.event
        target = eventObject.target <span class="keyword">or</span> eventObject.srcElement
        <span class="keyword">if</span> target.nodeType <span class="keyword">is</span> <span class="number">3</span> <span class="comment"># defeat Safari bug</span>
          target = target.parentNode
      
        <span class="keyword">if</span> node.domQueryHandlers[eventObject.type]
          handlers = node.domQueryHandlers[eventObject.type]
          result = <span class="literal">true</span>
          _.each handlers, (handlers, selector) -&gt;
            targetElement = checkIsElementMatchSelector selector, target, node
            <span class="keyword">if</span> targetElement
              result = callEventHandlers handlers, eventObject, targetElement
          result

      bindEvent node, eventName, delegateHandler
      node.domQueryDelegateHandler = delegateHandler

    handler.guid = handler.guid <span class="keyword">or</span> guid()
    node.domQueryHandlers = node.domQueryHandlers <span class="keyword">or</span> {}
    node.domQueryHandlers[eventName] = node.domQueryHandlers[eventName] <span class="keyword">or</span> {}
    node.domQueryHandlers[eventName][selector] = node.domQueryHandlers[eventName][selector] <span class="keyword">or</span> []
    node.domQueryHandlers[eventName][selector].push handler</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <h3>undelegateEvent(node, selector, eventName, handler)</h3>
<p>Отвязывает обработчика от делегирования событий с элементов по селектору</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="function"><span class="title">undelegateEvent</span></span> = (node, selector, eventName, handler) -&gt;
    <span class="keyword">return</span> <span class="literal">false</span> <span class="keyword">if</span> <span class="keyword">not</span> handler.guid
    <span class="keyword">return</span> <span class="literal">false</span> <span class="keyword">if</span> <span class="keyword">not</span> node.domQueryHandlers
    <span class="keyword">return</span> <span class="literal">false</span> <span class="keyword">if</span> <span class="keyword">not</span> node.domQueryHandlers[eventName]
    <span class="keyword">return</span> <span class="literal">false</span> <span class="keyword">if</span> <span class="keyword">not</span> node.domQueryHandlers[eventName][selector]
    handlers = node.domQueryHandlers[eventName][selector]
    index = <span class="literal">null</span>

    _.find handlers, (delegateHandler, handlerIndex) -&gt;
      index = handlerIndex
      delegateHandler.guid <span class="keyword">is</span> handler.guid

    <span class="keyword">if</span> index <span class="keyword">isnt</span> <span class="literal">null</span>
      handlers.splice index, <span class="number">1</span>
      node.domQueryHandlers[eventName][selector] = handlers</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <h3>domToHtml(plainHtml)</h3>
<p>Сериализует DOM-объекты в html-текст</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="function"><span class="title">domToHtml</span></span> = (domObject) -&gt;
    div = document.createElement(<span class="string">'DIV'</span>)
    div.appendChild domObject
    div.innerHTML</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <h3>parseHtml(plainHtml)</h3>
<p>Парсит html-текст в DOM-объекты</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="function"><span class="title">parseHtml</span></span> = (plainHtml) -&gt;
    div = document.createElement(<span class="string">'DIV'</span>)
    div.innerHTML = plainHtml
    <span class="keyword">for</span> node <span class="keyword">in</span> Array::slice.call div.childNodes
      <span class="keyword">if</span> node.nodeType <span class="keyword">is</span> <span class="number">3</span> <span class="keyword">and</span> <span class="keyword">not</span> <span class="regexp">///\S///</span>.test node.nodeValue
        div.removeChild node
    <span class="keyword">return</span> div.childNodes</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <h3>domQuery([selector])</h3>
<p>Конструктор domQuery для работы с DOM-элементами. Если переданный параметр уже является объектом domQuery, 
то просто возвращается этот экземпляр, также проверяется вызван ли конструктор с ключевым словом new, если нет,
то рекурсивно вызывается конструктор вместе с new.
Если параметр selector является строкой, то проверятеся, не является ли он html-строкой, если да, то парсится, если нет, то
подразумевается, что это dom-селектор и происходит поиск элементов, удовлетворяющих селектору.
Если selector не строка, то подразумевается, что это ссылка на dom-элемент, либо на nodeList (пока проверок точных еще нет)
Если selector не задан, то вместо него берется ссылка на document</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="function"><span class="title">domQuery</span></span> = (selector) -&gt;
    <span class="keyword">if</span> <span class="keyword">this</span> <span class="keyword">instanceof</span> domQuery
      <span class="keyword">return</span> selector <span class="keyword">if</span> selector <span class="keyword">instanceof</span> domQuery
      <span class="keyword">if</span> _.isString(selector)
        selector = selector.replace <span class="regexp">/^\s+|\s+$/</span>, <span class="string">""</span>
        <span class="keyword">if</span> selector.charAt(<span class="number">0</span>) <span class="keyword">is</span> <span class="string">"&lt;"</span> <span class="keyword">and</span> selector.charAt(selector.length - <span class="number">1</span>) <span class="keyword">is</span> <span class="string">"&gt;"</span> <span class="keyword">and</span> selector.length &gt;= <span class="number">3</span>
          elements = parseHtml selector
        <span class="keyword">else</span>
          elements = query selector
      <span class="keyword">else</span>
        elements = selector <span class="keyword">or</span> [document]

      <span class="keyword">if</span> elements.length <span class="keyword">is</span> <span class="literal">undefined</span> <span class="keyword">or</span> elements.nodeType <span class="keyword">is</span> <span class="number">3</span>
        elements = [elements]

      <span class="property">@length</span> = elements.length
      <span class="property">@selector</span> = selector
      _.each elements, (element, index) =&gt;
        @[index] = element
    <span class="keyword">else</span>
      <span class="keyword">new</span> domQuery selector

  domQuery:: =</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <h3>domQuery::on([selector], eventName, handler)</h3>
<p>Привязывает обработчика событий на элемент, либо для делегирования событий с элемента по селектору</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="literal">on</span>: (selector, eventName, handler) -&gt;
      binder = <span class="keyword">if</span> arguments.length <span class="keyword">is</span> <span class="number">3</span> <span class="keyword">then</span> delegateEvent <span class="keyword">else</span> bindEvent
      args = Array::slice.call(arguments)
      _.each <span class="property">@get</span>() , (node, index) -&gt;
        binder.apply @, [node].concat(args)
      @</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <h3>domQuery::off([selector], eventName, handler)</h3>
<p>Отключает обработчика событий элемента, либо от делегирования событий с элемента по селектору</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="literal">off</span>: (selector, eventName, handler) -&gt;
      unbinder = <span class="keyword">if</span> arguments.length <span class="keyword">is</span> <span class="number">3</span> <span class="keyword">then</span> undelegateEvent <span class="keyword">else</span> unbindEvent
      args = Array::slice.call(arguments)
      _.each <span class="property">@get</span>(), (node, index) -&gt;
        unbinder.apply @, [node].concat args
      @</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <h3>domQuery::find(selector)</h3>
<p>Возвращает элемент по селектору в контексте экземпляра domQuery</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    find: (selector) -&gt;
      <span class="keyword">return</span> domQuery query selector, <span class="property">@get</span>()</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <h3>domQuery::get([index])</h3>
<p>Возвращает элемент по идексу, либо массив элементов экземпляра domQuery</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    get: (index) -&gt;
      <span class="keyword">if</span> index?
        index = Math.max <span class="number">0</span>, Math.min index, <span class="property">@length</span> - <span class="number">1</span>
        @[index]
      <span class="keyword">else</span>
        <span class="keyword">return</span> Array::slice.call @</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <h3>domQuery::toString([index])</h3>
<p>Сериализует элементы в строку</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    toString: () -&gt;
      _.map <span class="property">@get</span>(), (node) -&gt;
        domToHtml node
      .join <span class="string">""</span></pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <h3>domQuery::replaceWith(element)</h3>
<p>заменяет первый элемент на указанный</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    replaceWith: (element) -&gt;
      @[<span class="number">0</span>] = @[<span class="number">0</span>].parentNode.replaceChild element[<span class="number">0</span>] <span class="keyword">or</span> element, @[<span class="number">0</span>]


  domQuery.<span class="function"><span class="title">load</span></span> = (name, req, onLoad, config) -&gt;
    domReady.load name, req, () -&gt;
        onLoad domQuery
      , config
    domQuery
        
  domQuery</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
