<!DOCTYPE html>

<html>
<head>
  <title>transition.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="ajax.html">
                ajax.coffee
              </a>
            
              
              <a class="source" href="app-require-config.html">
                app-require-config.coffee
              </a>
            
              
              <a class="source" href="app.html">
                app.coffee
              </a>
            
              
              <a class="source" href="clicks.html">
                clicks.coffee
              </a>
            
              
              <a class="source" href="anchors.html">
                anchors.coffee
              </a>
            
              
              <a class="source" href="forms.html">
                forms.coffee
              </a>
            
              
              <a class="source" href="config.html">
                config.coffee
              </a>
            
              
              <a class="source" href="dom.html">
                dom.coffee
              </a>
            
              
              <a class="source" href="events.html">
                events.coffee
              </a>
            
              
              <a class="source" href="history.html">
                history.coffee
              </a>
            
              
              <a class="source" href="async.html">
                async.coffee
              </a>
            
              
              <a class="source" href="loader.html">
                loader.coffee
              </a>
            
              
              <a class="source" href="sections.html">
                sections.coffee
              </a>
            
              
              <a class="source" href="asyncQueue.html">
                asyncQueue.coffee
              </a>
            
              
              <a class="source" href="cache.html">
                cache.coffee
              </a>
            
              
              <a class="source" href="invoker.html">
                invoker.coffee
              </a>
            
              
              <a class="source" href="loader.html">
                loader.coffee
              </a>
            
              
              <a class="source" href="transition.html">
                transition.coffee
              </a>
            
              
              <a class="source" href="destroyer.html">
                destroyer.coffee
              </a>
            
              
              <a class="source" href="guid.html">
                guid.coffee
              </a>
            
              
              <a class="source" href="log.html">
                log.coffee
              </a>
            
              
              <a class="source" href="logWriter.html">
                logWriter.coffee
              </a>
            
              
              <a class="source" href="params.html">
                params.coffee
              </a>
            
              
              <a class="source" href="storage.html">
                storage.coffee
              </a>
            
              
              <a class="source" href="ticker.html">
                ticker.coffee
              </a>
            
              
              <a class="source" href="widgetsData.html">
                widgetsData.coffee
              </a>
            
              
              <a class="source" href="widgets.html">
                widgets.coffee
              </a>
            
              
              <a class="source" href="gradient.html">
                gradient.coffee
              </a>
            
              
              <a class="source" href="opacity.html">
                opacity.coffee
              </a>
            
              
              <a class="source" href="perspective.html">
                perspective.coffee
              </a>
            
              
              <a class="source" href="rotation.html">
                rotation.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>transition.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h3><em>module</em> sections/transition</h3>
<p>Представляет собой звено для цепочки переходов, получая данные о секциях, и ссылку на предыдущий переход,
конструтктор Transition создает объект Invoker, устанавливает ссылку на новый объект в предыдущем объекте Transition,
и сохраняет ссылку на предыдущий Transition. Кроме того проходит по цепочке и удаляет записи, если длина цепочки превышает 10 объектов</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>define [
  <span class="string">"sections/invoker"</span>,
  <span class="string">"sections/asyncQueue"</span>,
  <span class="string">"events"</span>,
  <span class="string">"utils/destroyer"</span>], (Invoker, asyncQueue, events, destroyer) -&gt;

  transitionsCompressDepth = <span class="number">5</span>
  transitionsDestroyDepth = <span class="number">10</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h3>Transition(@data)</h3>
<p>Конструктор переходов, переходы образуют между собой двусторонний связанный список</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="function"><span class="title">Transition</span></span> = (<span class="property">@state</span>, last) -&gt;
    <span class="property">@index</span> = <span class="property">@state</span>.index = <span class="property">@state</span>.index <span class="keyword">or</span> (last?.index + <span class="number">1</span>) <span class="keyword">or</span> <span class="number">0</span>

    
    <span class="keyword">if</span> <span class="property">@state</span>.sections?
      <span class="property">@_invoker</span> = <span class="keyword">new</span> Invoker <span class="property">@state</span>.sections
      
    <span class="keyword">if</span> last?
      <span class="property">@prev_transition</span> = last
      last.next_transition = @
      last.next()</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Удаление старых записей
Стоит отметить, что проход всей цепочки вполне себе хороший способ удалить старые записи
так как позволяет удалять старые записи именно в этой цепочке переходов, не трогая остальные,
которые могут быть созданы про многочиленных переходах по истории и ссылкам на странице 
(история может ветвится, но цепочка от конца к началу не имеет ветвления)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      depth = transitionsDestroyDepth
      prevTransition = @
      <span class="keyword">while</span> depth--
        prevTransition = prevTransition.prev_transition
        <span class="keyword">if</span> <span class="keyword">not</span> prevTransition?
          <span class="keyword">break</span>;

      prevTransition?.destroy()

    <span class="keyword">return</span> @

  Transition:: =</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h3>Transition::update(data)</h3>
<p>Обновляет данные секций для перехода. Если новые данные совпадают с предыдущими, то ничего не происходит, 
иначе запускается механизм обновления секций, преждние секции удаляются, вместо них вставляются новые</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    update: (state) -&gt;
      isStateTheSame = <span class="literal">no</span>
      <span class="keyword">if</span> <span class="property">@state</span>.url <span class="keyword">is</span> state.url
        isStateTheSame = <span class="property">@state</span>.sections <span class="keyword">is</span> state.sections
      <span class="keyword">else</span>
        <span class="keyword">return</span>

      <span class="keyword">if</span> <span class="keyword">not</span> isStateTheSame
        state.index = <span class="property">@index</span>
        <span class="property">@state</span> = state
        <span class="keyword">if</span> <span class="property">@_invoker</span>? <span class="keyword">and</span> <span class="property">@state</span>.sections?
          <span class="property">@_invoker</span>.update <span class="property">@state</span>.sections
        <span class="keyword">else</span> <span class="keyword">if</span> <span class="property">@state</span>.sections?
          <span class="property">@_invoker</span> = <span class="keyword">new</span> Invoker <span class="property">@state</span>.sections

        <span class="property">@invoke</span>()

        asyncQueue.next -&gt;
          events.trigger <span class="string">"pageTransition:updated"</span>, {}


    destroy: () -&gt;
      destroyer @</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h3>Transition::next([to_transition])</h3>
<p>Переход вперед. Требует необязательный параметр to_transition, в котором должен находится индекс интересующего нас перехода.
Полезно, когда нужно перейти на несколько шагов вперед, в случае отсутсвия параметра, просто происходит переход на один шаг.
Если параметр совпадает с индексом перехода, то в очередь asynQueue добавляется инструкция, вызывающая событие &quot;pageTransition:success&quot;,
которое означает, что завершилась цепочка переходов</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    next: (to_transition) -&gt;
      transition = @
      <span class="keyword">if</span> to_transition <span class="keyword">isnt</span> <span class="property">@index</span> <span class="keyword">and</span> <span class="property">@next_transition</span>?
        transition = <span class="property">@next_transition</span>
        <span class="property">@next_transition</span>.invoke()
        <span class="keyword">if</span> to_transition? <span class="keyword">then</span> <span class="property">@next_transition</span>.next(to_transition)

      <span class="keyword">if</span> to_transition <span class="keyword">is</span> <span class="property">@index</span> <span class="keyword">or</span> <span class="keyword">not</span> to_transition
        asyncQueue.next -&gt;
          events.trigger <span class="string">"pageTransition:success"</span>,
            transition: transition
      @</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <h3>Transition::next([to_transition])</h3>
<p>Переход назад. Работает аналогично Transition::next требует необязательный параметр to_transition, только переходы идут в другом направлении </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    prev: (to_transition) -&gt;
      transition = @
      <span class="keyword">if</span> to_transition <span class="keyword">isnt</span> <span class="property">@index</span> <span class="keyword">and</span> <span class="property">@prev_transition</span>?
        transition = <span class="property">@prev_transition</span>
        <span class="property">@undo</span>()
        <span class="keyword">if</span> to_transition? <span class="keyword">then</span> <span class="property">@prev_transition</span>.prev(to_transition)

      <span class="keyword">if</span> to_transition <span class="keyword">is</span> <span class="property">@index</span> <span class="keyword">or</span> <span class="keyword">not</span> to_transition
        asyncQueue.next -&gt;
          events.trigger <span class="string">"pageTransition:success"</span>,
            transition: transition
      @</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <h3>Transition::undo()</h3>
<p>Отмена действий перехода. Помимо отката действий объекта Invoker, запускает события &quot;transition:undo&quot; и &quot;transition:current:update&quot;,
где в &quot;transition:current:update&quot; передается ссылка на предыдущий переход, а в &quot;transition:undo&quot; на текущий</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    undo: () -&gt;
      <span class="property">@_invoker</span>?.undo()
      events.trigger <span class="string">"transition:undo"</span>, @
      events.trigger <span class="string">"transition:current:update"</span>, <span class="property">@prev_transition</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <h3>Transition::invoke()</h3>
<p>Применение действий перехода. Помимо применения действий объекта Invoker, запускает события &quot;transition:invoked&quot; и &quot;transition:current:update&quot;,
где в &quot;transition:current:update&quot; и &quot;transition:invoked&quot; передается ссылка на текущий переход</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    invoke: () -&gt;
      <span class="property">@_invoker</span>?.run()
      events.trigger <span class="string">"transition:invoked"</span>, @
      events.trigger <span class="string">"transition:current:update"</span>, @


  <span class="keyword">return</span> Transition</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
